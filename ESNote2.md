   
[책 엘라스틱 서치 실무 가이드](https://book.naver.com/bookdb/book_detail.nhn?bid=14733062) 공부하고 내용 정리  
      
- - -   
    
## Ch1. 검색 시스템 이해하기     
    
     
### 검색시스템 구성 요소  
  
* 수집기 : 검색시 필요한 정보 수집  
* 스토리지 : 수집한 데이터 저장(물리적인 저장소)     
* 색인기 : 수집한 데이터를 검색에 적절한 형태로 변환  
          색인기는 다양한 형태소 분석기를 조합해 정보에서 의미가 있는 용어르 추출하여 검색에 유리한 역색인 구조로 데이터 저장   
* 검색기 : 색인된 데이터에서 일치하는 문서 찾음    
          검색 질의와 문서가 일치하는지는 유사도 기반의 검색 순위 알고리즘으로 판단  
          검색기 또한 색인기와 마찬가지로 형태소 분석기를  이용해 사용자 질의에서 유의미한 용어를 추출하여 검색  
          따라서 형태소 분석기에 따라서 검색 품질이 달라짐  
    
     
엘라스틱서치 VS 관계형 데이터 베이스 비교  
인덱스(index) - 데이터베이스(database)  
샤드(shard) - 파티션(partition)  
타입(type) - 테이블(table)  
문서(document) - 행(row)  
필드(field) - 열(column)  
매핑(mapping) - 스키마(schema)  
Query DSL - sql   
   
엘라스틱서치의 인덱스는 RDMBS의 데이터베이스와 비슷한 문서의 모음을 뜻함.  
엘라스틱서치 6.0 이후 버전에서는 하나의 인덱스에 하나의 타입만 구성되도록 변경됨.  
엘라스틱서치의 매핑은 필드의 구조와 제약조건에 대한 명세를 말하며, RDBMS의 스키미와 유사함.  
   
    
엘라스틱서치는데이터추가,수정,삭제할 때 HTTP를 통해서 JSON 형색의 RESTFUL API를 이용함.  
<table>
<tr>
  <th> 엘라스틱서치에서 사용하는 HTTP 메서드 </th> <th> 기능 </th> <th> 데이터베이스 질의 문법 </th>  
</tr>
<tr>
  <td> GET </td> <td> 데이터 조회 </td> <td> SELECT </td>
</tr>
<tr>  
  <td> PUT </td> <td> 데이터 생성 </td> <td> INSERT </td>
</tr>
<tr>  
  <td> POST </td> <td> 인덱스 업데이트, 데이터 조회 </td> <td> UPDATE, SELECT </td>
</tr>
<tr>  
  <td> DELETE </td> <td> 인덱스 삭제 </td> <td> DELETE </td>
</tr>
<tr>
  <td> HEAD </td> <td> 인덱스 정보 확인 </td> <td> - </td>  
</tr>
</table>
    
      
### 엘라스틱 서치 장점  
   
* 오픈소스 검색엔진  
* 전문(full-text) 검색 지원  
  전문 검색은 내용 전체를 색인해서 특정 단어가 포함된 문서를 검색하는 것.  
  기존 관계형 DB는 전문 검색에 적합하지 않지만, 엘라스틱서치는 다양한 기능별, 언어별 플러그인을 조합해 빠르게 검색 가능  
* 통계 분석  
  비정형 로그 데이터를 수집하고 한곳에 모아 통계 분석 가능  
  엘라스틱서치와 키바나를 연결하면 실시간으로 쌓이는 로그를 시각화하고 분석가능  
* 멀티테넌시(Multi-tenancy)  
  서로 다른 인덱스라도 검색할 필드명만 같으면 여러개의 인덱스를 한번에 조회가능, 이를 이용해 멀티 테넌시 기능 제공  
* 역색인(inverted index) 지원   
  [역색인 관련 내용 참고](https://esbook.kimjmin.net/06-text-analysis/6.1-indexing-data)   
        
             
- - -   
    
     
## Ch2. 엘라스칙서치 살펴보기   
         
      
* 엘라스틱 서치는 인덱스(Index), 타입(Type), 문서(Document), 필드(Field) 구조로 구성됨.    
       
### 인덱스(Index)  
데이터 저장 공간  
하나의 인덱스는 하나의 타입만을 가짐.  
하나의 물리적인 노드에 여러 개의 논리적인 인덱스 생성 가능.   
엘라스틱서치를 분산 환경으로 구성하면 하나의 인덱스가 여러 노드에 분산 저장되어 관리됨.  
엘라스틱서치는 인덱스 생서이 기본적으로 5개의 프라이머리(primary) 샤드와 1개의 레플리카(replica)샤드 세트를 생성.  
(각각의 샤드 수는 인덱스 생성시 옵션값 변경으로 변경 겨능)   
인덱스 이름은 모두 소문자여야함.  
추가,수정,삭제,검색은 RESTful API로 이루어짐.   
        
### 샤드(Shard)    
색인된 문서는 하나의 인덱스에 담김.  
인덱스 내부에 색인된 데이터는 물리적인 공간에 열 개의 파티션으로 나뉘어 구성되는데, 이 파티션이 샤드.   
엘라스틱서치는 다수의 샤드로 문서를 분산 저장하고 있어 데이터 손실 위험을 최소화할 수 있음.  
     
### 타입(Type)  
타입은 인덱스의 논리적인 구조를 의미.  
엘라스틱서치 6.0 버전 이하에서는 하나의 인덱스에 여러 타입 설정이 가능하지만, 6.1버전부터는 인덱스당 하나의 타입만 설정 가능.  
      
### 문서(Document)    
문서는 엘라스틱서치에서 데이터가 저장되는 최소 단위.   
기본적으로 JSON 포맷으로 데이터가 저장됨.  
하나의 문서는 다수의 필드로 구성되는데, 각 필드는 데이터의 형태에 따라 용도에 맞는 데이터 타입(data type)을 정의해야함.  
문서는 중첩 구조를 지원하기 떄문에 문서 안에 문서를 지정하는 것도 가능.   
   
### 필드(Field)  
필드(Field)는 문서를 구성하기 위한 속성  
RDBMS에서 컬럼(Column)과 유사하나 컬럼이 정적(static) 데이터 타입인 반면에, 필드는 조금 더 동적(dynamic)인 데이터로 볼 수 있음.  
하나의 필드는 목적에 따라 다수의 데이터 타입을 가질 수 있음.  
예를 들어서, 영화 제목 검색을 할 때 매칭 검색을 하거나 초성을 이용한 검색이 모두 지원되도록 제목 필드는 2개의 데이터 타입을 가져야함.  
     
### 매핑(Mapping)   
매핑은 문서의 필드와 필드의 속성을 정의하고, 그에 따른 색인 방법을 정의하는 프로세스.   
인덱스의 매핑 정보에는 여러 개의 데이터 타입을 지정하는 것이 가능하지만, 필드명 중복 사용은 불가.   
     
       
       
### 엘라스틱 서치에서 제공하는 주요 API   
    
엘라스칙서치에서 사용하는 API 종류  
* 인덱스 관리 API(Indices API) : 인덱스 관리  
* 문서 관리 API(Document API) : 문서의 추가/수정/삭제   
* 검색 API(Search API) : 문서 조회   
* 집계 API(Aggregatin API) : 문서 통계  
       
cf) Index VS Indices   
   색인은 데이터가 토큰화되어 저장된 자료구조를 의미 -> Index   
   엘라스틱서치에서는 인덱스라는 용어를 색인과 다른 의미로 사용   
      
   * Index : 색인 데이터  
   * Indexing : 색인하는 과정  
   * Indices : 매핑 정보를 저장하는 논리적인 데이터 공간  
      
   엘라스틱서치에서는 용어에 따른 혼란은 방지하기 위해 색인을 의미할 경우 "Index"라는 단어를 사용하고,  
   매핑 정의 공간을 의미할 경우 "Indices"라는 단어로 표현한다.   
        
엘라스틱 서치는 사용 편의 성을 위해 스키마리스(Schemeless) 기능을 제공.  
문서를 색인하기 위해서는 기본적으로 인덱스를 생성하는 과정이 필요한데, 인덱스 생성하는 과정 없이 문서를 추가하더라도 문서가 색인되도록 지원하는 일종의 편의 기능.  
하지만, 엘라스틱 서치의 스키마리스 특성은 데이터에 대한 매핑을 자동으로 생성하는 편리한 기능을 제공하지만, 특수한 상황에서만 제한적으로 사용해야함.(실무에서는 거의 사용X -> 검색 품질을 떨어트림, 성능 이슈있음)  
      
      
### 인덱스 관리 API  
    
인덱스 생성할 때는 매핑이라는 세부 설정을 이용할 수 있는데, 매핑은 문서와 문서에 포함된 필드, 필드 타입등을 세세하게 지정할 수 있는 설정방식.  
한번 생성된 매핑 정보는 변경 할 수 없고, 잘못 생성했거나 변경해야하는 경우에는 데이터를 삭제하고 다시 생성하는 수 밖에 없음.   
    
엘라스틱서치는 다양한 형태의 데이터 타입 제공.  
단순히 문자열로 저장하고 싶을 때는 keyword 타입 사용 형태소 분석을 원할 경우 text 타입 사용  
    
인덱스는 한번 삭제하면 다시 복구할 수 없기 때문에 신중하게 해야함.  
     
     
### 문서 관리 API    
    
* Index API : 한 건의 문서를 색인.  
* Get API : 한 건의 문서 조회.  
* Delete API : 한 건의 문서 삭제.  
* Update API : 한 건의 문서 업데이트.    
   
문서 관리 API는 기본적으로 한 건의 문서를 처리 하기 위한 기능을 제공하며 `Single Document API`라고 부름.  
하지만 다수의 문서를 처리하는 경우를 위한 `Multi-Document API`도 제공   
    
* Multi Get API : 다수의 문서 조회.   
* Bulk API : 대량의 문서 색인.  
* Delete By Query API : 다수의 문서 삭제.   
* Update By Query API : 다수의 문서 업데이트  
* Reindex API : 인덱스 문서 다시 색인   
      
문서를추가 할떄 Id 값을 지정하지 않으면, 엘라스틱 서치가 자동으로 `_id` 값을 생성한다.  
(`_id`값은 UUID를 통해 무작위로 생성된다.)    
     
만약, 엘라스틱 서치와 동기화된 DB의 데이터가 변경되었다고 해보자.  
검색엔진은 해당 데이터베이스와 주기적으로 동기화해야 하기 떄문에 변경된 내용을 따라 동기화 해주어야한다.  
이를 위해서는 엘라스틱서치에 색인된 `_id`값과 데이터베이스의 PK 혹은 식별 되는 키값과 매칭된 정보가 어딘가에 저장되어 관리되어야 한다.   
하지만 데이터 사이즈가 너무 클 경우 식별값을 어딘가에 별도로 저장하는건 쉬운 일이 아니다.  
그래서 색인된 문서의 `_id`값은 업데이트를 고려해서 데이터베이스 테이블의 식별값과 맞춰주는것이 좋다.   
        
        
### 검색 API    
     
엘라스틱 서치 검색 API 사용 방식은 다음과 같이 크게 두가지로 나뉜다.  
1. HTTP URI(Uniform Resource Identifier) 형태의 파라미터를 URI에 추가해 검색하는 방법.  
2. Restful API 방식인 QueryDSL를 사용해 요청 본문(Request Body)에 질의 내용을 추가해 검색하는 방법.  
      
      
### 집계 API    
    
#### 데이터 집계   
movie 인덱스의 문서를 장르별로 집계해보자.  
`_search` API를 사용해 집계 쿼리를 만들고 terms 키워드를 이용해 genreAlt라는 필드의 데이터를 그룹화한다.  
   
```
POST /movie/_search?size=0
{
   "aggs" : {
      "genre" : {
         "temrs" : {
            "field" : "genreAlt" 
         }
      }
   }
}
```   
   
위와 같이 질의하면 결과는 다음과 같을 것이다.    
   
``` 
{
   "took" : 10,
   "timed_out" : false,
   "_shards" : {
      "total" : 5,
      "succesful" : 5,
      "skipped" : 0,
      "faield" : 0
   },
   "hits" : {
      "total" : 63069,
      "max_score" : 0,
      "hits" : [
      ]
   },
   "aggregations" : {
      "genre" : {
         "doc_count_error_upper_bound" : 291,
         "sum_other_doc_count" : 21317,
         "buckets"  [
            {
               "key" : "드라마",
               "doc_count" : 18648
            },
            {
               "key" : "장르없음",
               "doc_count" : 16325
            }
            
            (... 생략 ...) 
         ]
      }
   }
}
```  
     
집계 결과를 살펴보면`버킷(BUckets)`이라는 구조 안에 그룹화된 데이터가 포함되어 있다.  
엘라스틱서치의 집계가 강력한 이유중 하나는 버킷 안에 다른 버킷의 결과를 추가할 수 있다는 것이다.  
이러한 특성을 이용해 다양한 집계 유형을 결합하거나 중첩, 조합하는 것이 가능해진다.  
      
다음은 장르별 국가 형태를 중첩해서 보여주는 집계의 예이다.  
        
```  
POST movie/_search?size=0
{
   "aggs" : {
      "genre" : {
         "terms" : {
            "field" : "genreAlt"
         }
      },
      "aggs" : {
         "nation" : {
            "terms" : {
               "field" : "nationAlt"
            }
         }
      }
   }
}
```   
     
        
### 데이터 집계 타입   
집계 기능은 현재 4가지 API로 제공되고 있다.  
    
* 버킷 집계(Bucket Aggregation)    
  집계 중 가장 많이 사용, 문서의 필드를 기준으로 버킷 집계  
* 메트릭 집계(Metric Aggregation)   
  문서에서 추출된 값을 가지고 Sum, Max, Min, Agv를 계산.  
* 메트릭스 집계(Matrix Aggregation)   
  행렬의 값을 합하거나 곱함.   
* 파이프라인 집계(Pipeline Aggregation)   
  버킷에서 도출된 결과 문서를 다른 필드 값으로 재분류.   
  즉, 다른 집계에 의해 생성된 출력 결과를 다시 한번 집계   
      
     
     
     

   
     
  


    
   
